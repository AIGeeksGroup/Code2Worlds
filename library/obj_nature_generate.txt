# ===================== leaf Example (High Precision + Semantic Parameters) =====================
# Example: Generate leaf_v2 using custom parameters and save as .blend
# Run method (headless): blender -b -P obj_generate.txt --python-exit-code 1
# Note: Please adjust PYTHONPATH, output path, and Blender executable path according to actual paths.

import sys
import bpy

# Ensure infinigen package can be found
sys.path.append(r"D:\infinigen")

from infinigen.assets.objects.leaves.leaf_v2 import LeafFactoryV2

# Optional: Clear scene
bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Create factory (coarse=False for high precision)
factory = LeafFactoryV2(factory_seed=12345, coarse=False)

# -------------- Custom Parameter Example (can be generated by LLM and written) --------------
g = factory.genome
g["leaf_shape_control_points"] = [(0.0, 0.0), (0.3, 0.3), (0.7, 0.35), (1.0, 0.0)]
g["midrib_length"] = 0.7
g["midrib_width"] = 0.95
g["stem_length"] = 0.85
g["vein_angle"] = 1.2
g["vein_asymmetry"] = 0.2
g["vein_density"] = 18.0
g["jigsaw_depth"] = 1.4
g["jigsaw_scale"] = 16.0
g["subvein_scale"] = 18.0
g["y_wave_control_points"] = [(0.0, 0.5), (0.5, 0.58), (1.0, 0.5)]
g["x_wave_control_points"] = [(0.0, 0.5), (0.4, 0.56), (0.5, 0.5), (0.6, 0.56), (1.0, 0.5)]

# Material/Color (optional, example is healthy dark green, prominent veins, no blight)
factory.blade_color_hsv = (0.33, 0.7, 0.6)
factory.vein_color_mix_factor = 0.5
factory.blight_color_hsv = (0.12, 0.5, 0.55)
# Blight/spot control (explicit settings, no randomness)
import numpy as np
blight_weight = 0              # 0=disable blight
dotted_blight_weight = 0       # 0=disable spots
blight_area_factor = 0.3       # Blight area ratio

import contextlib
@contextlib.contextmanager
def override_blight(binomial_val, blight_area):
    old_binom = np.random.binomial
    old_uniform = np.random.uniform
    np.random.binomial = lambda n, p, size=None: binomial_val
    np.random.uniform = lambda a, b=None, size=None: blight_area if b is not None else binomial_val
    try:
        yield
    finally:
        np.random.binomial = old_binom
        np.random.uniform = old_uniform

# -------------- Generate Leaf --------------
with override_blight(blight_weight, blight_area_factor):
    leaf_obj = factory.create_asset()

# -------------- Save as .blend --------------
output_path = r"D:\tmp\custom_leaf.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path)
print(f"saved to {output_path}")

# ===================== Cactus Example (High Precision + Semantic Parameters) =====================
# Run method same as above; will append cactus generation and save another .blend
import bpy
from infinigen.assets.objects.cactus.generate import CactusFactory
from infinigen.assets.objects.cactus.columnar import ColumnarBaseCactusFactory
from infinigen.assets.objects.cactus.globular import GlobularBaseCactusFactory
from infinigen.assets.objects.cactus.pricky_pear import PrickyPearBaseCactusFactory

# Optional: Clear again to avoid scene containing both leaf and cactus; comment out if you want to keep the leaf
bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Morphology selection (can be decided by LLM semantics: columnar/globular/prickly pear)
factory_method = ColumnarBaseCactusFactory  # Example: columnar
factory = CactusFactory(factory_seed=20240101, coarse=False, factory_method=factory_method)

# Common spike/surface/precision parameters (can be driven by semantics)
factory.factory.spike_distance = 0.02   # Spike spacing, smaller = denser
factory.factory.density = 8e4           # Spike density
factory.factory.base_radius = 0.0025    # Spike thickness
factory.factory.cap_percentage = 0.12   # Top spike ratio
factory.factory.noise_strength = 0.05   # Surface roughness
face_size = 0.008                       # Remesh face length, high precision

# Morphology-specific parameters (columnar example)
if isinstance(factory.factory, ColumnarBaseCactusFactory):
    factory.factory.radius_decay = 0.55       # Trunk shrinkage ratio
    factory.factory.radius_decay_root = 0.75  # Root thickness
    factory.factory.leaf_alpha = 2.8          # Top tapering exponent

# Morphology-specific parameters (globular example, need to switch factory_method=GlobularBaseCactusFactory)
if isinstance(factory.factory, GlobularBaseCactusFactory):
    # Override geo_globular to use custom star_resolution / frequency
    def geo_globular_custom(nw):
        import numpy as np
        from numpy.random import uniform
        from infinigen.core.nodes.node_info import Nodes
        star_resolution = 10  # Number of ridges (6~12)
        resolution = 64
        frequency = 0.05      # Twist frequency (-0.2~0.2)
        circle = nw.new_node(Nodes.MeshCircle, [star_resolution * 3])
        selection = nw.compare("EQUAL", nw.math("MODULO", nw.new_node(Nodes.Index), 2), 0)
        circle, selection = nw.new_node(Nodes.CaptureAttribute, [circle, selection]).outputs[:2]
        circle = nw.new_node(
            Nodes.SetPosition,
            [circle, selection, nw.scale(nw.new_node(Nodes.InputPosition), uniform(1.1, 1.2))],
        )
        profile_curve = nw.new_node(Nodes.MeshToCurve, [circle])
        curve = nw.new_node(Nodes.ResampleCurve, [nw.new_node(Nodes.CurveLine), None, resolution])
        anchors = [(0, 0.3), (0.5, 0.65), (0.82, 0.5), (1.0, 0.05)]
        radius = nw.scalar_multiply(
            nw.build_float_curve(nw.new_node(Nodes.SplineParameter), anchors, "AUTO"), 0.8
        )
        curve = nw.new_node(Nodes.SetCurveRadius, [curve, None, radius])
        curve = nw.new_node(
            Nodes.SetCurveTilt,
            [curve, None, nw.scalar_multiply(nw.new_node(Nodes.SplineParameter), 2 * np.pi * frequency)],
        )
        geometry = nw.curve2mesh(curve, profile_curve)
        nw.new_node(Nodes.GroupOutput, input_kwargs={"Geometry": geometry, "Selection": selection})

    factory.factory.geo_globular = staticmethod(geo_globular_custom)

# Morphology-specific parameters (prickly pear example, need to switch factory_method=PrickyPearBaseCactusFactory)
if isinstance(factory.factory, PrickyPearBaseCactusFactory):
    factory.factory.spike_distance = 0.08  # Prickly pear default is sparser, can adjust density
    factory.factory.density = 1.5e4
    # Simple scaling of pads, simulating pad_scale; more complex quantity/orientation requires source code modification
    factory.factory.pad_scale = 0.6 if hasattr(factory.factory, "pad_scale") else None

# Material: Uses internal shader random base_hue; if fixed is needed, can be set in shader_cactus

# Generate cactus
cactus_obj = factory.create_asset(face_size=face_size, realize=True)

output_path_cactus = r"D:\tmp\custom_cactus.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_cactus)
print(f"saved to {output_path_cactus}")

# ===================== Cloud Example (High Precision + Semantic Parameters) =====================
# Uses key parameters from ojb_fine: CloudFactory / Cumulus
import bpy
from infinigen.assets.objects.cloud.generate import CloudFactory
from infinigen.assets.objects.cloud.cloud import Cumulus, Cumulonimbus, Stratocumulus, Altocumulus

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Factory parameters (high precision cumulus example)
cloud_factory = CloudFactory(
    factory_seed=4242,
    coarse=False,
    steps=256,                # Reference grid resolution
    cloudy=("bool", 0.0),     # Only select cumulus, not cumulonimbus
    max_distance=400,         # Far view resolution decay threshold
)

# Override distribution/placement parameters
cloud_factory.cloud_types = [Cumulus]                   # Semantics: cumulus
cloud_factory.resolutions = {Cumulus: (64, 256)}        # Resolution range
cloud_factory.min_distance = 64
cloud_factory.dome_radius = 256
cloud_factory.dome_threshold = 0
cloud_factory.density_range = [1e-4, 2e-4]              # Placement density range

# Override single cloud morphology/material parameters (corresponding to Cumulus key parameters in ojb_fine)
def cumulus_get_scale(self):
    return [60.0, 70.0, 28.0]  # scale XYZ

def cumulus_sample_curves(self):
    # Profile curve control points: flat bottom, rounded bulge
    return [
        [-0.90, -1.00],
        [0.00, 0.82],
        [0.50, 0.88],
        [1.00, 0.95],
    ]

def cumulus_get_params(self):
    return {
        "density": 1.0,
        "anisotropy": 0.1,
        "noise_scale": 10.0,
        "noise_detail": 12.0,
        "voronoi_scale": 3.5,
        "mix_factor": 0.6,
        "rotate_angle": 0.1,
        "emission_strength": 0.0,
    }

def cumulus_update_geo_params(self, geo_params):
    geo_params = dict(geo_params)
    return geo_params

def cumulus_update_shader_params(self, shader_params):
    shader_params = dict(shader_params)
    # Fix shader density, avoid randomness
    shader_params["density"] = 0.15
    return shader_params

# Apply overrides
Cumulus.get_scale = cumulus_get_scale
Cumulus.sample_curves = cumulus_sample_curves
Cumulus.get_params = cumulus_get_params
Cumulus.update_geo_params = cumulus_update_geo_params
Cumulus.update_shader_params = cumulus_update_shader_params

# Generate cloud; distance controls resolution mapping
cloud_obj = cloud_factory.create_asset(distance=100)

output_path_cloud = r"D:\tmp\custom_cloud.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_cloud)
print(f"saved to {output_path_cloud}")

# ===================== Creatures Example (CrustaceanFactory, High Precision + Semantic Parameters) =====================
# Uses parameters from ojb_fine: species, face_size, animate, rigging, cloth, factory_seed
import bpy
from infinigen.assets.objects.creatures.crustacean import CrustaceanFactory, crustacean_postprocessing
from infinigen.assets.objects.creatures.util.joining import join_and_rig_parts
from infinigen.assets.objects.creatures.util.joining import get_parts
from infinigen.core.util import blender as butil

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Create factory and fix species and seed
cru_factory = CrustaceanFactory(factory_seed=5678, coarse=False)
cru_factory.species = "lobster"  # Options: lobster | crab | spiny_lobster

# Semantic parameters (high precision, with animation, riggable, no cloth)
cru_face_size = 0.006
cru_animate = True
cru_rigging = True
cru_cloth = False

# Fix crustacean_postprocessing parameter issue: create wrapper function
def create_asset_fixed(self, i, animate=True, rigging=True, cloth=False, **kwargs):
    """Fixed version of create_asset, correctly handles crustacean_postprocessing parameters"""
    from infinigen.assets.objects.creatures.crustacean import crustacean_genome
    from infinigen.assets.objects.creatures.util.creature import genome_to_creature
    from infinigen.core.surface import assign_material
    from infinigen.assets.objects.creatures.crustacean import shader_eye
    from infinigen.core.surface import shaderfunc_to_material
    from infinigen.core.util.math import FixedSeed
    
    with FixedSeed(self.factory_seed):
        genome = crustacean_genome(self.species_params[self.species]())
        root, parts = genome_to_creature(
            genome, name=f"crustacean({self.factory_seed}, {i})"
        )
        for p in parts:
            if p.obj.name.split("=")[-1] == "CrustaceanEyeFactor":
                assign_material(p.obj, shaderfunc_to_material(shader_eye))
        
        # Create wrapped postprocess_func, extract body_parts and extras from root
        # Note: At this point body_parts have been joined into one object
        def wrapped_postprocess(root_obj):
            # After join, body_parts are direct child objects of root (MESH type)
            body_parts = [o for o in root_obj.children if o.type == "MESH"]
            # extras are other non-body_parts MESH objects
            extras = [o for o in butil.iter_object_tree(root_obj) 
                     if o not in body_parts and o is not root_obj and o.type == "MESH"]
            params = genome.postprocess_params
            crustacean_postprocessing(body_parts, extras, params)
        
        joined, extras, arma, ik_targets = join_and_rig_parts(
            root,
            parts,
            genome,
            postprocess_func=wrapped_postprocess,
            rigging=rigging,
            min_remesh_size=0.005,
            face_size=kwargs["face_size"],
            roll="GLOBAL_POS_Z",
        )
        if animate and arma is not None:
            from infinigen.assets.objects.creatures.crustacean import animate_crustacean_move
            animate_crustacean_move(arma, genome.postprocess_params["anim"])
        else:
            butil.join_objects([joined] + extras)
        return root

# Temporarily replace create_asset method
original_create_asset = CrustaceanFactory.create_asset
CrustaceanFactory.create_asset = create_asset_fixed

# create_asset requires i (instance index), face_size precision
cru_obj = cru_factory.create_asset(
    i=0,
    animate=cru_animate,
    rigging=cru_rigging,
    cloth=cru_cloth,
    face_size=cru_face_size,
)

# Restore original method (optional)
CrustaceanFactory.create_asset = original_create_asset

output_path_cru = r"D:\tmp\custom_crustacean.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_cru)
print(f"saved to {output_path_cru}")

# ===================== Monocot Example (High Precision + Semantic Parameters) =====================
# Uses parameters from ojb_fine: factory_method/factory, max_cluster, face_size, count, angle, min_y_angle/max_y_angle, leaf_prob/leaf_range, stem_offset, scale_curve, radius, bend_angle, twist_angle, z_drag, z_scale, align_factor/align_direction, base_hue/bright_color/dark_color
import bpy
import numpy as np
from infinigen.assets.objects.monocot.generate import MonocotFactory
from infinigen.assets.objects.monocot.grasses import GrassesMonocotFactory, MaizeMonocotFactory

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision grass cluster (Grasses), many leaves, curved, slightly drooping, dark green
mono_factory_seed = 24680
mono_face_size = 0.006     # High precision
max_cluster = 4            # Max 4 plants per cluster
factory_method = GrassesMonocotFactory  # Can switch to MaizeMonocotFactory etc.

mono_factory = MonocotFactory(factory_seed=mono_factory_seed, coarse=False, factory_method=factory_method, grass=True)
mono_factory.max_cluster = max_cluster

# Override sub-factory key morphology and color (GrassesMonocotFactory base parameters)
sub_fac = mono_factory.factory
sub_fac.count = 48
sub_fac.angle = 0.5              # Leaf spacing angle (smaller = denser)
sub_fac.min_y_angle = 0.38 * np.pi
sub_fac.max_y_angle = 0.48 * np.pi
sub_fac.leaf_prob = 0.9
sub_fac.leaf_range = (0.0, 1.0)
sub_fac.stem_offset = 1.8
sub_fac.scale_curve = [(0, 1.0), (1, 0.2)]
sub_fac.radius = 0.01
sub_fac.bend_angle = np.pi / 2
sub_fac.twist_angle = np.pi / 6
sub_fac.z_drag = 0.15
sub_fac.z_scale = 1.1
sub_fac.align_factor = 0.2
sub_fac.align_direction = (1, 0, 0)
sub_fac.base_hue = 0.10
sub_fac.bright_color = (0.1, 0.7, 0.3, 1.0)  # HSV->RGBA simplified example
sub_fac.dark_color = (0.08, 0.9, 0.1, 1.0)

# Generate cluster (MonocotFactory will generate 1~5 plants based on grass=True; here fixed parameters still follow internal logic for random quantity and distribution)
monocot_obj = mono_factory.create_asset(i=0, face_size=mono_face_size)

output_path_mono = r"D:\tmp\custom_monocot.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_mono)
print(f"saved to {output_path_mono}")

# ===================== Rocks Example (BoulderFactory + BlenderRockFactory, High Precision + Semantic Parameters) =====================
# Uses parameters from ojb_fine: do_voronoi, octree_depth, adapt_mesh_method, face_size, has_horizontal_cut, is_slab, configs/weights, detail, zscale, zrand, deform, rough
import bpy
from infinigen.assets.objects.rocks.boulder import BoulderFactory
from infinigen.assets.objects.rocks.blender_rock import BlenderRockFactory

# ========== BoulderFactory Example (Boulder, High Precision + Voronoi) ==========

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision boulder, with Voronoi texture, octree depth 4, face length 0.008, boulder morphology
boulder_factory_seed = 9999
boulder_face_size = 0.008     
boulder_do_voronoi = True      
boulder_octree_depth = 4       
boulder_adapt_mesh_method = "remesh"
boulder_has_horizontal_cut = True
boulder_is_slab = False
boulder_configs = ["boulder"]
boulder_weights = [1.0, 0.0]   

boulder_factory = BoulderFactory(
    factory_seed=boulder_factory_seed,
    coarse=False,
    do_voronoi=boulder_do_voronoi,
    adapt_mesh_method=boulder_adapt_mesh_method,
)
boulder_factory.octree_depth = boulder_octree_depth
boulder_factory.has_horizontal_cut = boulder_has_horizontal_cut
boulder_factory.is_slab = boulder_is_slab
boulder_factory.configs = boulder_configs
boulder_factory.weights = boulder_weights

# Create placeholder and generate asset
boulder_placeholder = boulder_factory.create_placeholder(boulder_scale=1.0)
boulder_obj = boulder_factory.create_asset(
    i=0,
    placeholder=boulder_placeholder,
    face_size=boulder_face_size,
    distance=0,
)

output_path_boulder = r"D:\tmp\custom_boulder.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_boulder)
print(f"saved to {output_path_boulder}")

# ========== BlenderRockFactory Example (Blender Built-in Rock, High Precision) ==========
import bpy
from infinigen.assets.objects.rocks.blender_rock import BlenderRockFactory
bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: Blender high precision rock, detail level 3, medium deformation, rough
blender_rock_factory_seed = 7777
blender_rock_detail = 3         # High precision
blender_rock_zscale = 0.5       # Medium height
blender_rock_zrand = 0.4        # Medium randomness
blender_rock_deform = 6         # Medium deformation
blender_rock_rough = 0.8       # Rougher

blender_rock_factory = BlenderRockFactory(
    factory_seed=blender_rock_factory_seed,
    detail=blender_rock_detail,
)

# Create wrapper function to control parameters (BlenderRockFactory's create_asset internally generates random parameters)
def create_asset_blender_rock_fixed(self, zscale=None, zrand=None, deform=None, rough=None, **params):
    """Fixed version of create_asset, allows control of zscale, zrand, deform, rough"""
    from infinigen.core.init import require_blender_addon
    from infinigen.core.util import blender as butil
    from infinigen.core.tagging import tag_object
    from numpy.random import uniform as U
    import numpy as np
    
    require_blender_addon("extra_mesh_objects")
    
    seed = np.random.randint(0, 99999)
    
    # Use passed parameters, otherwise use default random range
    zscale = zscale if zscale is not None else U(0.2, 0.8)
    zrand = zrand if zrand is not None else U(0, 0.7)
    deform = deform if deform is not None else U(2, 10)
    rough = rough if rough is not None else U(0.5, 1.0)
    
    while True:
        try:
            kwargs = dict(
                use_random_seed=False,
                user_seed=seed,
                display_detail=self.detail,
                detail=self.detail,
                scale_Z=(zrand * zscale, zscale),
                scale_fac=(1, 1, 1),
                scale_X=(1.00, 1.01),
                scale_Y=(1.00, 1.01),
                deform=deform,
                rough=rough,
            )
            bpy.ops.mesh.add_mesh_rock(**kwargs)
            break
        except (IndexError, RuntimeError):
            pass
    
    obj = bpy.context.active_object
    bpy.ops.object.shade_flat()
    butil.apply_modifiers(obj)
    tag_object(obj, "blender_rock")
    return obj

original_create_asset_blender = BlenderRockFactory.create_asset
BlenderRockFactory.create_asset = create_asset_blender_rock_fixed

blender_rock_obj = blender_rock_factory.create_asset(
    zscale=blender_rock_zscale,
    zrand=blender_rock_zrand,
    deform=blender_rock_deform,
    rough=blender_rock_rough,
)

BlenderRockFactory.create_asset = original_create_asset_blender

output_path_blender_rock = r"D:\tmp\custom_blender_rock.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_blender_rock)
print(f"saved to {output_path_blender_rock}")

# ===================== Trees Examples (TreeFactory + BranchFactory, High Precision + Semantic Parameters) =====================
import bpy
from infinigen.assets.objects.trees.generate import TreeFactory, BushFactory
from infinigen.assets.objects.trees.branch import BranchFactory
from infinigen.core.util.math import FixedSeed
import numpy as np

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

tree_factory_seed = 11111
tree_season = "summer"
tree_fruit_chance = 1.0
tree_n_leaf = 8
tree_n_twig = 3
tree_leaf_type = ["leaf_v2"]
tree_face_size = 0.008
tree_coarse = False
tree_realize = False
tree_adapt_mesh_method = "remesh"

tree_factory = TreeFactory(
    seed=tree_factory_seed,
    season=tree_season,
    coarse=tree_coarse,
    fruit_chance=tree_fruit_chance,
    adapt_mesh_method=tree_adapt_mesh_method,
)
tree_factory.n_leaf = tree_n_leaf
tree_factory.n_twig = tree_n_twig

original_get_leaf_type = TreeFactory.get_leaf_type
def get_leaf_type_fixed(season):
    return tree_leaf_type
TreeFactory.get_leaf_type = staticmethod(get_leaf_type_fixed)

tree_placeholder = tree_factory.create_placeholder(i=0, loc=(0, 0, 0), rot=(0, 0, 0))
tree_obj = tree_factory.create_asset(
    placeholder=tree_placeholder,
    face_size=tree_face_size,
    distance=0,
)

TreeFactory.get_leaf_type = original_get_leaf_type


output_path_tree = r"D:\tmp\custom_tree.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_tree)
print(f"saved to {output_path_tree}")

# ========== BushFactory Example (High Precision Bush, Spring) ==========

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision bush, spring, face length 0.01
bush_factory_seed = 33333
bush_n_leaf = 4                # Number of leaves
bush_n_twig = 4                # Number of twigs
bush_face_size = 0.01          # High precision
bush_coarse = False
bush_realize = False
bush_adapt_mesh_method = "remesh"

bush_factory = BushFactory(
    seed=bush_factory_seed,
    coarse=bush_coarse,
    adapt_mesh_method=bush_adapt_mesh_method,
)
bush_factory.n_leaf = bush_n_leaf
bush_factory.n_twig = bush_n_twig

# Note: BushFactory internally randomly selects leaf_type (["leaf_v2", "flower", "berry"])
# If fixed type is needed, source code modification or more complex monkey patch is required

bush_placeholder = bush_factory.create_placeholder(i=0, loc=(0, 0, 0), rot=(0, 0, 0))
bush_obj = bush_factory.create_asset(
    placeholder=bush_placeholder,
    face_size=bush_face_size,
    distance=0,
)

output_path_bush = r"D:\tmp\custom_bush.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_bush)
print(f"saved to {output_path_bush}")

# ===================== Flower Example (FlowerFactory, High Precision + Semantic Parameters) =====================
# Uses parameters from obj_fine: factory_seed, rad, diversity_fac, Center Rad, Petal Dims, Min/Max Petal Angle, Seed Size, Wrinkle, Curl
import bpy
from infinigen.assets.objects.grassland.flower import FlowerFactory
from infinigen.core.util.math import FixedSeed
from infinigen.core.util import blender as butil
import numpy as np

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: large, open petals, prominent wrinkles, pink flower
flower_factory_seed = 5555
flower_rad = 0.25              # Flower size
flower_diversity_fac = 0.3     # Diversity factor

# Override FlowerFactory.get_flower_params to control specific morphology parameters
def get_flower_params_fixed(overall_rad=0.05):
    return {
        "Center Rad": 0.05,  # Flower center radius
        "Petal Dims": np.array([0.2, 0.03, 0.15], dtype=np.float32),  # [length, base width, tip width]
        "Seed Size": 0.008,  # Seed size
        "Min Petal Angle": np.deg2rad(-5),   # Minimum petal angle
        "Max Petal Angle": np.deg2rad(85),   # Maximum petal angle
        "Wrinkle": 0.015,    # Wrinkle strength
        "Curl": np.deg2rad(30),  # Curl angle
    }

# Temporarily replace static method, ensure __init__ uses fixed parameters
original_get_flower_params = FlowerFactory.get_flower_params
FlowerFactory.get_flower_params = staticmethod(get_flower_params_fixed)

flower_factory = FlowerFactory(
    factory_seed=flower_factory_seed,
    rad=flower_rad,
    diversity_fac=flower_diversity_fac,
)

# Generate flower
flower_obj = flower_factory.create_asset()

FlowerFactory.get_flower_params = original_get_flower_params

output_path_flower = r"D:\tmp\custom_flower.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_flower)
print(f"saved to {output_path_flower}")

# ===================== Mushroom Example (MushroomFactory, High Precision + Semantic Parameters) =====================
# Uses parameters from obj_fine: factory_seed, coarse, face_size, max_cluster, maker, lowered, base_hue, n_mushrooms, tolerant_length
import bpy
import numpy as np
from infinigen.assets.objects.mushroom.generate import MushroomFactory
from infinigen.assets.objects.mushroom.growth import MushroomGrowthFactory
from infinigen.core.util.math import FixedSeed
from infinigen.core import surface
from infinigen.core.util import blender as butil
from infinigen.assets.utils.object import join_objects
from infinigen.core.tagging import tag_object

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision, ring cluster, upright, red cap, 4 mushrooms
mushroom_factory_seed = 7777
mushroom_coarse = False
mushroom_face_size = 0.008     # High precision

# Morphology parameters
mushroom_maker = "cluster"     # Clustering method ("cluster"=ring cluster, "directional"=directional arrangement)
mushroom_lowered = False       # Whether tilted (False=upright, True=tilted)
mushroom_n_mushrooms = 4       # Number of mushrooms (1~5)
mushroom_tolerant_length = 0.1 # Keypoint tolerance length (0.0~0.2, affects cluster density)

# Color parameters
mushroom_base_hue = 0.02       # Base hue (0.0-0.05 red, 0.05-0.15 brown, 0.3-0.4 green, 0.6-0.7 blue)

# Create factory
mushroom_factory = MushroomFactory(
    factory_seed=mushroom_factory_seed,
    coarse=mushroom_coarse,
)
mushroom_factory.max_cluster = 10

# Override maker and lowered
if mushroom_maker == "cluster":
    mushroom_factory.maker = mushroom_factory.cluster_make
elif mushroom_maker == "directional":
    mushroom_factory.maker = mushroom_factory.directional_make

mushroom_factory.lowered = mushroom_lowered
mushroom_factory.tolerant_length = mushroom_tolerant_length

# Override base_hue to control color
mushroom_factory.factory.base_hue = mushroom_base_hue
mushroom_factory.factory.material_func = lambda: surface.shaderfunc_to_material(
    mushroom_factory.factory.shader_mushroom, mushroom_base_hue
)
# Recreate cap_factory and stem_factory to use new base_hue
from infinigen.assets.objects.mushroom.cap import MushroomCapFactory
from infinigen.assets.objects.mushroom.stem import MushroomStemFactory
mushroom_factory.factory.cap_factory = MushroomCapFactory(
    mushroom_factory_seed, mushroom_base_hue, mushroom_factory.factory.material_func, mushroom_coarse
)
mushroom_factory.factory.stem_factory = MushroomStemFactory(
    mushroom_factory_seed, 
    mushroom_factory.factory.cap_factory.inner_radius, 
    mushroom_factory.factory.material_func, 
    mushroom_coarse
)

# Override build_mushrooms to control mushroom count
def build_mushrooms_custom(self, i, face_size=0.01):
    """Custom build_mushrooms, allows control of mushroom count"""
    n = mushroom_n_mushrooms  # Use custom count instead of random
    mushrooms, keypoints = [], []
    for j in range(n):
        obj = self.factory.create_asset(
            i=j + i * self.max_cluster, face_size=face_size / 2
        )
        from infinigen.core.util.blender import deep_clone_obj
        clone = deep_clone_obj(obj)
        butil.modify_mesh(clone, "REMESH", voxel_size=0.04)
        mushrooms.append(obj)
        k = np.array(
            [v.co for v in clone.data.vertices if v.co[-1] > self.tolerant_length]
        )
        if len(k) == 0:
            k = np.array([v.co for v in clone.data.vertices])
        if len(k) == 0:
            k = np.zeros((1, 3))
        keypoints.append(k)
        butil.delete(clone)
    return mushrooms, keypoints

# Temporarily replace build_mushrooms
original_build_mushrooms = MushroomFactory.build_mushrooms
MushroomFactory.build_mushrooms = build_mushrooms_custom

# Generate mushroom cluster
mushroom_obj = mushroom_factory.create_asset(i=0, face_size=mushroom_face_size)

MushroomFactory.build_mushrooms = original_build_mushrooms

output_path_mushroom = r"D:\tmp\custom_mushroom.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_mushroom)
print(f"saved to {output_path_mushroom}")
print(f"Mushroom parameters: maker={mushroom_maker}, lowered={mushroom_lowered}, n_mushrooms={mushroom_n_mushrooms}, base_hue={mushroom_base_hue}")

# ===================== Fruit Example (FruitFactoryApple, High Precision + Semantic Parameters) =====================
# Uses parameters from obj_fine: factory_seed, scale, coarse, radius_control_points, color1/color2, surface_resolution
import bpy
from infinigen.assets.objects.fruits.apple import FruitFactoryApple

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision, red, medium-sized apple
fruit_factory_seed = 9999
fruit_scale = 1.0              # Global scale
fruit_coarse = False

fruit_factory = FruitFactoryApple(
    factory_seed=fruit_factory_seed,
    scale=fruit_scale,
    coarse=fruit_coarse,
)

# Note: Most FruitFactory parameters are randomly generated in internal methods
# If precise color control is needed, can override sample_surface_params method
def sample_surface_params_fixed(self):
    from infinigen.core.util.color import hsv2rgba
    import numpy as np
    from numpy.random import uniform
    
    base_color = np.array((0.05, 1.0, 0.80))  # Red apple
    base_color_rgba = hsv2rgba(base_color)
    
    alt_color = np.array((0.02, 0.95, 0.75))
    alt_color_rgba = hsv2rgba(alt_color)
    
    return {
        "surface_name": "apple_surface",
        "surface_func_args": {
            "color1": base_color_rgba,
            "color2": alt_color_rgba,
            "random_seed": uniform(-100, 100),
        },
        "surface_input_args": {
            "Geometry": "noderef-shapequadratic-Mesh",
            "spline parameter": "noderef-shapequadratic-spline parameter",
            "spline tangent": "noderef-shapequadratic-spline tangent",
            "distance to center": "noderef-shapequadratic-radius to center",
        },
        "surface_output_args": {},
        "surface_resolution": 64,
        "scale_multiplier": 1.0,
    }

# Temporarily replace method
original_sample_surface = FruitFactoryApple.sample_surface_params
FruitFactoryApple.sample_surface_params = sample_surface_params_fixed

# Generate apple
fruit_obj = fruit_factory.create_asset()

FruitFactoryApple.sample_surface_params = original_sample_surface

output_path_fruit = r"D:\tmp\custom_fruit.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_fruit)
print(f"saved to {output_path_fruit}")

# ===================== Coral Example (BrainCoralFactory, High Precision + Semantic Parameters) =====================
# Uses parameters from obj_fine: factory_seed, coarse, factory_method, face_size, realize, base_hue, noise_strength
import bpy
from infinigen.assets.objects.corals.generate import BrainCoralFactory
from infinigen.core.util.math import FixedSeed

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision, brain-shaped, pink, rough surface coral
coral_factory_seed = 11111
coral_coarse = False
coral_face_size = 0.008        # High precision
coral_realize = True

coral_factory = BrainCoralFactory(
    factory_seed=coral_factory_seed,
    coarse=coral_coarse,
)

# Control color: override base_hue
with FixedSeed(coral_factory_seed):
    coral_factory.base_hue = 0.95  # 粉色
    
    coral_factory.material = surface.shaderfunc_to_material(
        coral_factory.shader_coral, coral_factory.base_hue
    )
    print(f"✓ Updated coral material color to pink (base_hue={coral_factory.base_hue})")

# Generate coral
coral_obj = coral_factory.create_asset(face_size=coral_face_size, realize=coral_realize)

output_path_coral = r"D:\tmp\custom_coral.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_coral)
print(f"saved to {output_path_coral}")

# ===================== Mollusk Example (ConchFactory, High Precision + Semantic Parameters) =====================
# Uses parameters from obj_fine: factory_seed, coarse, factory_method, face_size, base_hue, x_scale, z_scale, distortion
import bpy
from infinigen.assets.objects.mollusk.generate import ConchFactory

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision, conch, brown, clear spiral pattern
mollusk_factory_seed = 33333
mollusk_coarse = False
mollusk_face_size = 0.008      # High precision

mollusk_factory = ConchFactory(
    factory_seed=mollusk_factory_seed,
    coarse=mollusk_coarse,
)

# Note: MolluskFactory's x_scale/z_scale/distortion are used in shader
# These parameters are passed through factory.factory attributes in __init__
# Default parameters are already reasonable, modification requires adjustment at sub-factory level

# Generate conch
mollusk_obj = mollusk_factory.create_asset(face_size=mollusk_face_size)

output_path_mollusk = r"D:\tmp\custom_mollusk.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_mollusk)
print(f"saved to {output_path_mollusk}")

# ===================== Seaweed Example (SeaweedFactory, High Precision + Semantic Parameters) =====================
# Uses parameters from obj_fine: factory_seed, coarse, face_size, growth_vec, max_polygons, fac_noise, inhibit_shell, repulsion_radius, base_hue
import bpy
import numpy as np
from infinigen.assets.objects.underwater.seaweed import SeaweedFactory
from infinigen.core.util.math import FixedSeed
from infinigen.core import surface
from infinigen.assets.utils.decorate import read_co, subsurface2face_size, write_co
from infinigen.assets.utils.draw import make_circular_interp
from infinigen.assets.utils.misc import assign_material
from infinigen.core import util
import infinigen.core.util.blender as butil
from infinigen.core.tagging import tag_object
from infinigen.core.util.random import log_uniform


bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: high precision, dark green, long blades, strong edge waves, large sway amplitude
seaweed_factory_seed = 55555
seaweed_coarse = False
seaweed_face_size = 0.008      # High precision

# Differential growth parameters (control seaweed morphology)
seaweed_growth_vec = (0, 0, 5.5)       # Vertical growth height (3.0~6.0, larger = longer)
seaweed_inhibit_shell = 0.7            # Inhibit shell layer (0.6~0.8, larger = smoother edges)
seaweed_max_polygons = 8000            # Max polygon count (2000~10000, larger = more detailed)
seaweed_fac_noise = 2.3                # Noise factor (1.5~2.5, larger = more irregular edges)
seaweed_repulsion_radius = 1.2         # Repulsion radius (1.0~1.5, affects blade spacing)
seaweed_dt = 0.25                      # Time step (fixed)

# Color parameters
seaweed_base_hue = 0.35                # Dark green (0.0-0.1 yellow-green, 0.3-0.4 dark green)


seaweed_factory = SeaweedFactory(
    factory_seed=seaweed_factory_seed,
    coarse=seaweed_coarse,
)

# Override base_hue to control color
seaweed_factory.base_hue = seaweed_base_hue
seaweed_factory.material = surface.shaderfunc_to_material(
    seaweed_factory.shader_seaweed, seaweed_base_hue
)

# Override create_asset method to control morphology parameters
def create_asset_custom(self, face_size=0.01, **params):
    """Custom create_asset, allows control of differential growth parameters"""
    # Use custom parameters instead of random generation
    obj = self.differential_growth_make(
        fac_noise=seaweed_fac_noise,
        inhibit_shell=seaweed_inhibit_shell,
        repulsion_radius=seaweed_repulsion_radius,
        growth_vec=seaweed_growth_vec,
        dt=seaweed_dt,
        max_polygons=seaweed_max_polygons,
    )

    # Scale and position adjustment
    obj.scale = [2 / max(obj.dimensions)] * 3
    obj.scale[-1] *= 1.8  # Vertical stretch (1.5~2.0)
    obj.location[-1] -= 0.02
    butil.apply_transform(obj, loc=True)
    
    # Circular interpolation scaling (control blade width variation)
    f_scale = make_circular_interp(2, 5, 5, log_uniform)
    x, y, z = read_co(obj).T
    scale = f_scale(np.arctan2(y, x) + np.pi)
    co = np.stack([scale * x, scale * y, z], -1)
    write_co(obj, co)
    
    # Subdivision and smoothing
    subsurface2face_size(obj, face_size / 2)
    butil.modify_mesh(obj, "TRIANGULATE")
    butil.modify_mesh(obj, "SMOOTH", factor=0.5)
    
    # Texture displacement
    texture = bpy.data.textures.new(name="seaweed", type="STUCCI")
    texture.noise_scale = 0.1
    butil.modify_mesh(
        obj, "DISPLACE", True, strength=0.02, texture=texture
    )
    
    assign_material(obj, self.material)
    self.animate_bend(obj)
    tag_object(obj, "seaweed")
    return obj

# Temporarily replace create_asset method
original_create_asset = SeaweedFactory.create_asset
SeaweedFactory.create_asset = create_asset_custom

# Generate seaweed
seaweed_obj = seaweed_factory.create_asset(face_size=seaweed_face_size)


SeaweedFactory.create_asset = original_create_asset


output_path_seaweed = r"D:\tmp\custom_seaweed.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_seaweed)
print(f"saved to {output_path_seaweed}")
print(f"Seaweed parameters: growth_vec={seaweed_growth_vec}, max_polygons={seaweed_max_polygons}, fac_noise={seaweed_fac_noise}")

# ===================== Urchin Example (Simplified Version, High Precision + Color Control) =====================
# Run method (headless): blender -b -P obj_nature_generate.txt --python-exit-code 1
# Note: Please adjust output path and Blender executable path according to actual paths.

import bpy
import infinigen.core.util.blender as butil
from infinigen.assets.objects.underwater.urchin import UrchinFactory
from infinigen.core import surface

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# ========== Semantic Example: Purple urchin, slow breathing ==========
urchin_factory_seed = 77777
urchin_coarse = False
urchin_face_size = 0.008

urchin_factory = UrchinFactory(factory_seed=urchin_factory_seed, coarse=urchin_coarse)

# Modify color and animation parameters
urchin_factory.base_hue = 0.75          # Purple (0.75=purple, 0.0=red, 0.5=cyan, 0.08=orange)
urchin_factory.freq = 1/180             # Breathing frequency (1/180=slow, 1/100=fast)

# Key: Must recreate material after modifying base_hue
urchin_factory.materials = [
    surface.shaderfunc_to_material(shader, urchin_factory.base_hue)
    for shader in [urchin_factory.shader_spikes, urchin_factory.shader_girdle, urchin_factory.shader_base]
]

# Create placeholder and generate urchin
placeholder = butil.spawn_vert("urchin_placeholder")
urchin_obj = urchin_factory.create_asset(placeholder=placeholder, face_size=urchin_face_size)
butil.delete([placeholder])

output_path_urchin = r"D:\tmp\custom_urchin.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_urchin)
print(f"saved to {output_path_urchin}")
print(f"Urchin: base_hue={urchin_factory.base_hue}, freq={urchin_factory.freq}")

# Note:
# 1. Spike length, urchin shape and other parameters are randomly generated inside create_asset, cannot be easily controlled
# 2. Can get different random morphologies by modifying factory_seed
# 3. If complete control of all morphology parameters is needed, need to override geo_extrude and create_asset methods (more complex)



# ===================== Dandelion  =====================
# Manually specify flower_mode through monkey patching
import bpy
import numpy as np
from infinigen.assets.objects.grassland.dandelion import DandelionFactory

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

dandelion_factory_seed_advanced = 22222
dandelion_coarse_advanced = False

dandelion_factory_advanced = DandelionFactory(factory_seed=dandelion_factory_seed_advanced, coarse=dandelion_coarse_advanced)

# Manually specify mode: force generate full flower ball
desired_mode = "full_flower"  # Options: "full_flower", "no_flower", "top_half_flower", "top_missing_flower", "sparse_flower"

# Override create_asset method to fix mode
original_create_asset_dandelion = DandelionFactory.create_asset
def create_asset_fixed_mode(self, **params):
    """Fixed flower_mode version"""
    bpy.ops.mesh.primitive_plane_add(
        size=1,
        enter_editmode=False,
        align="WORLD",
        location=(0, 0, 0),
        scale=(1, 1, 1),
    )
    obj = bpy.context.active_object
    
    # Use fixed mode
    mode = desired_mode
    params = self.get_mode_params(mode)
    
    from infinigen.core import surface
    from infinigen.assets.objects.grassland.dandelion import geometry_dandelion_nodes
    surface.add_geomod(
        obj,
        geometry_dandelion_nodes,
        apply=True,
        attributes=[],
        input_kwargs=params,
    )
    from infinigen.core.tagging import tag_object
    tag_object(obj, "dandelion")
    return obj

DandelionFactory.create_asset = create_asset_fixed_mode

# Generate dandelion
dandelion_obj_advanced = dandelion_factory_advanced.create_asset()

DandelionFactory.create_asset = original_create_asset_dandelion

output_path_dandelion_advanced = r"D:\tmp\custom_dandelion_advanced.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_dandelion_advanced)
print(f"saved to {output_path_dandelion_advanced}")
print(f"Dandelion advanced: mode={desired_mode}")



# ===================== GrassTuft Advanced Version - Control Blade Count =====================
# Control n_blades (blade count) through monkey patching
import bpy
import numpy as np
from infinigen.assets.objects.grassland.grass_tuft import GrassTuftFactory

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

grass_seed_advanced = 11111
grass_factory_advanced = GrassTuftFactory(seed=grass_seed_advanced)

# Set other parameters
grass_factory_advanced.length_mean = 0.10
grass_factory_advanced.curl_mean = 45
grass_factory_advanced.blade_width_pct_mean = 0.025

# Fix blade count (through monkey patch)
desired_n_blades = 55  # Custom count (dense grass tuft)

# Override create_asset method
original_create_asset_grass = GrassTuftFactory.create_asset
def create_asset_fixed_blades(self, **params):
    """Fixed n_blades version"""
    import numpy as np
    from numpy.random import normal, uniform
    from infinigen.assets.utils.geometry.curve import Curve
    from infinigen.core.util import blender as butil
    
    # Use fixed n_blades
    n_blades = desired_n_blades
    
    blade_lengths = normal(self.length_mean, self.length_std, (n_blades, 1))
    seg_lens = blade_lengths / self.n_seg
    
    seg_curls = normal(self.curl_mean, self.curl_std, (n_blades, self.n_seg))
    seg_curls *= np.power(
        np.linspace(0, 1, self.n_seg).reshape(1, self.n_seg), self.curl_power
    )
    seg_curls = np.deg2rad(seg_curls)
    
    point_rads = np.arange(self.n_seg).reshape(1, self.n_seg) * seg_lens
    point_angles = np.cumsum(seg_curls, axis=-1)
    point_angles -= point_angles[:, [0]]
    
    points = np.empty((n_blades, self.n_seg, 2))
    points[..., 0] = np.cumsum(point_rads * np.cos(point_angles), axis=-1)
    points[..., 1] = np.cumsum(point_rads * np.sin(point_angles), axis=-1)
    
    taper = Curve(self.taper_points).to_curve_obj()
    
    widths = blade_lengths.reshape(-1) * normal(
        self.blade_width_pct_mean, self.blade_width_var, n_blades
    )
    objs = []
    for i in range(n_blades):
        obj = Curve(points[i], taper=taper).to_curve_obj(
            name=f"_blade_{i}", extrude=widths[i], resu=2
        )
        objs.append(obj)
    
    with butil.SelectObjects(objs):
        bpy.ops.object.convert(target="MESH")
    butil.delete(taper)
    
    base_angles = uniform(0, 2 * np.pi, n_blades)
    base_rads = uniform(0, self.base_spread, n_blades)
    facing_offsets = np.rad2deg(normal(0, self.base_angle_var, n_blades))
    for a, r, off, obj in zip(base_angles, base_rads, facing_offsets, objs):
        obj.location = (-r * np.cos(a), r * np.sin(a), -0.05 * self.length_mean)
        obj.rotation_euler = (np.pi / 2, -np.pi / 2, -a + off)
    
    with butil.SelectObjects(objs):
        bpy.ops.object.transform_apply(location=True, rotation=True, scale=True)
    
    with butil.SelectObjects(objs):
        bpy.ops.object.join()
        bpy.ops.object.shade_flat()
        parent = objs[0]
    
    from infinigen.core.tagging import tag_object
    tag_object(parent, "grass_tuft")
    
    return parent


GrassTuftFactory.create_asset = create_asset_fixed_blades

# Generate grass tuft
grass_obj_advanced = grass_factory_advanced.create_asset()

# Apply material
grass_factory_advanced.finalize_assets([grass_obj_advanced])

GrassTuftFactory.create_asset = original_create_asset_grass

output_path_grass_advanced = r"D:\tmp\custom_grass_tuft_advanced.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_grass_advanced)
print(f"saved to {output_path_grass_advanced}")
print(f"GrassTuft advanced: n_blades={desired_n_blades}, length_mean={grass_factory_advanced.length_mean}")

# ===================== Fern Manual Parameter Control Example =====================
# If need to control fern morphology, can pass through params parameter
import bpy
from infinigen.assets.objects.small_plants.fern import FernFactory

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

fern_factory_seed_manual = 77777
fern_coarse_manual = False

fern_factory_manual = FernFactory(factory_seed=fern_factory_seed_manual, coarse=fern_coarse_manual)

# Manually control parameters through params
fern_params = {
    "fern_mode": "all_grownup",  # Or "young_and_grownup"
    "scale": 0.03,                # Overall scale (default 0.02)
    "version_num": 6,             # Blade version count (default 5)
    "pinnae_num": 25,             # Pinnae count (default randint(12, 30))
}

# Generate fern
fern_obj_manual = fern_factory_manual.create_asset(**fern_params)


output_path_fern_manual = r"D:\tmp\custom_fern_manual.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_fern_manual)
print(f"saved to {output_path_fern_manual}")
print(f"Fern with manual parameters: mode={fern_params['fern_mode']}, scale={fern_params['scale']}, pinnae_num={fern_params['pinnae_num']}")

# ===================== Fish Example (FishFactory, Simplified Version) =====================
# Note: FishFactory depends on complex genome system, parameters are automatically generated internally
import bpy
from infinigen.assets.objects.creatures.fish import FishFactory

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: fish (morphology automatically generated by genome system)
fish_factory_seed = 11111
fish_coarse = False

fish_factory = FishFactory(factory_seed=fish_factory_seed, coarse=fish_coarse)

# Generate fish (i is instance index)
fish_obj = fish_factory.create_asset(i=0)

output_path_fish = r"D:\tmp\custom_fish.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_fish)
print(f"saved to {output_path_fish}")
print(f"Fish generated with factory_seed={fish_factory_seed}")

# ===================== jellyfish Example =====================
# Control jellyfish morphology by directly modifying factory attributes
import bpy
from infinigen.assets.objects.creatures.jellyfish import JellyfishFactory

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# ========== Example 1: Cyan-blue, thin bell, long tentacles, transparent jellyfish ==========
jellyfish_factory_seed_1 = 44444
jellyfish_coarse_1 = False
jellyfish_face_size_1 = 0.008

jellyfish_factory_1 = JellyfishFactory(factory_seed=jellyfish_factory_seed_1, coarse=jellyfish_coarse_1)

# Manually modify morphology attributes
jellyfish_factory_1.base_hue = 0.55              # Cyan-blue (0.5=standard cyan, 0.55=cyan-blue)
jellyfish_factory_1.cap_thickness = 0.1         # Thin bell
jellyfish_factory_1.cap_z_scale = 1.2           # Slightly elongated
jellyfish_factory_1.cap_dent = 0.25             # Wavy edges
jellyfish_factory_1.has_arm = True              # Has long tentacles
jellyfish_factory_1.arm_length = 4.5            # Long tentacles
jellyfish_factory_1.tentacle_length = 2.3       # Longer edge tentacles
jellyfish_factory_1.length_scale = 1.5          # Overall tentacle lengthening
jellyfish_factory_1.anim_freq = 1/40            # Faster breathing

# Key step: Must recreate material after modifying base_hue!
# Because material was already generated with old base_hue during __init__
jellyfish_factory_1.outside_material = jellyfish_factory_1.make_transparent()
jellyfish_factory_1.inside_material = jellyfish_factory_1.make_transparent()
jellyfish_factory_1.tentacle_material = jellyfish_factory_1.make_transparent()
jellyfish_factory_1.arm_mat_transparent = jellyfish_factory_1.make_transparent()
jellyfish_factory_1.arm_mat_opaque = jellyfish_factory_1.make_opaque()
jellyfish_factory_1.arm_mat_solid = jellyfish_factory_1.make_solid()

# Generate jellyfish
jellyfish_obj_1 = jellyfish_factory_1.create_asset(face_size=jellyfish_face_size_1)

# Clean all Shape Keys from all objects before saving to avoid invalid from pointer causing save errors
def _clear_all_shape_keys():
    for o in bpy.data.objects:
        data = getattr(o, "data", None)
        keys = getattr(data, "shape_keys", None)
        if not keys or not getattr(keys, "key_blocks", None):
            continue
        try:
            while keys.key_blocks:
                keys.key_blocks.remove(keys.key_blocks[0])
        except Exception as e:
            print(f"Warning: failed to clear shape keys for {o.name}: {e}")

_clear_all_shape_keys()

output_path_jellyfish_1 = r"D:\tmp\custom_jellyfish_cyan.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_jellyfish_1)
print(f"saved to {output_path_jellyfish_1}")
print(f"Jellyfish 1: base_hue={jellyfish_factory_1.base_hue}, cap_thickness={jellyfish_factory_1.cap_thickness}, arm_length={jellyfish_factory_1.arm_length}")

# ===================== PalmTree Example (PalmTreeFactory, Simplified Version) =====================
# Note: PalmTreeFactory can pass a few parameters through params
import bpy
from infinigen.assets.objects.tropic_plants.palm_tree import PalmTreeFactory


bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Semantic example: tall palm tree
palm_factory_seed = 44444
palm_coarse = False

palm_factory = PalmTreeFactory(factory_seed=palm_factory_seed, coarse=palm_coarse)

# Optional: Control some parameters through params
palm_params = {
    "trunk_height": 8.0,   # Trunk height (optional)
    "leaf_scale": 1.2,     # Leaf scale (optional)
}

# Generate palm tree
palm_obj = palm_factory.create_asset(params=palm_params)

output_path_palm = r"D:\tmp\custom_palm_tree.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_palm)
print(f"saved to {output_path_palm}")
print(f"PalmTree generated with factory_seed={palm_factory_seed}, params={palm_params}")

# ===================== ChoppedTrees Example (Chopped Tree Trunk Debris Scatter, High Precision + Semantic Parameters) =====================
import bpy
import numpy as np
from infinigen.assets.scatters.chopped_trees import ChoppedTrees

bpy.ops.object.select_all(action="SELECT")
bpy.ops.object.delete()

# Create a simple ground plane as base_obj for debris scatter
ground_size = 4.0
bpy.ops.mesh.primitive_plane_add(size=ground_size, location=(0, 0, 0))
ground = bpy.context.active_object
ground.name = "ChoppedTreeGround"

# Semantic example 1: Few thick trunk segments, like several logs left after recent felling
chopped_species_seed = 12345
chopped_n_trees = 1            # All debris from same tree
chopped_boolean_res_mult = 3.0 # Medium cutting surface precision
chopped_scale = 1.2            # Slightly enlarged overall
chopped_scale_rand = 0.2       # Small size variance, relatively uniform
chopped_scale_rand_axi = 0.1   # Weak axial stretching
chopped_ground_offset = 0.05   # Slightly raised to avoid intersection
chopped_density = 0.3          # Sparse scatter

chopped = ChoppedTrees()
scatter_obj, chopped_col = chopped.apply(
    obj=ground,
    species_seed=chopped_species_seed,
    n_trees=chopped_n_trees,
)

# Adjust some scale/offset parameters of scatter object
scatter_obj.scale = (chopped_scale, chopped_scale, chopped_scale)
bpy.context.view_layer.update()


output_path_chopped = "./obj_blend/V_choppedtree.blend"
bpy.ops.wm.save_as_mainfile(filepath=output_path_chopped)
print(f"saved to {output_path_chopped}")
print(f"ChoppedTrees: species_seed={chopped_species_seed}, n_trees={chopped_n_trees}")
